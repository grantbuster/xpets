% Function fGetLocalContrast returns local luminosity contrast data

function LocalContrast = fGetLocalContrast(ImageFileName,ScanRange)

% INPUT

% ImageFileName
%   Type: String
%   Desc: Image filename input.
% ScanRange
%   Type: Double
%   Size: (2x1) or (1x2)
%   Unit: Pixels
%   Desc: ScanRange(1) and ScanRange(2) are the minimum and maximum
%   distances (in pixels) to be included in the contrast calculation.
%   Recommended value is [2 4] for X-PREX image processing.

% OUTPUT

% LocalContrast
%   Type: Double
%   Size: Same as Original Input File

%--------------------------------------------------------------------------
% TEST INPUT
%--------------------------------------------------------------------------
% clear all
% 
% % Set the Image File Name
% ImageFileName = '20141114_01/20141114_01000_0000.jpg'; % +000.0 Deg
% 
% % Set the Scan Range for Neighboring Pixels (Pixels)
% ScanRange = [2 4];

%--------------------------------------------------------------------------
% FUNCTION CODE
%--------------------------------------------------------------------------

% Load the Image
I = imread(ImageFileName);

% Reset Image Scale
I = double(I(:,:,1))/255;

% Determine the Size of the Image File
N_Pixel = [length(I(:,1)) length(I(1,:))];

% Determine Neigbor Pixels to Scan
ScanRange_Min = min(ScanRange);
ScanRange_Max = max(ScanRange);

N_Scan = 2*ScanRange_Max + 1;

dX_Scan = zeros(N_Scan);
dY_Scan = zeros(N_Scan);
ScanPixel = zeros(N_Scan);

i_Center = ScanRange_Max + 1;
j_Center = ScanRange_Max + 1;

for i = 1:N_Scan
    for j = 1:N_Scan
        
        dX_Scan(i,j) = i - i_Center;
        dY_Scan(i,j) = j - j_Center;
        
        Distance = ((i - i_Center)^2 + (j - j_Center)^2)^0.5;
        
        if Distance >= ScanRange_Min && Distance <= ScanRange_Max
            ScanPixel(i,j) = 1;
        end
        
    end
end

% Initialize Contrast Tally
LocalContrast = zeros(N_Pixel(1),N_Pixel(2));

% Scan All Pixels Away from the Edges
for i = ScanRange_Max+1:N_Pixel(1)-ScanRange_Max
    for j = ScanRange_Max+1:N_Pixel(2)-ScanRange_Max
        
        % Scan Neighboring Pixels
        for n = 1:N_Scan
            for m = 1:N_Scan
                
                if ScanPixel(n,m)
                    i_Test = i + dX_Scan(n,m);
                    j_Test = j + dY_Scan(n,m);
                    
                    LocalContrast(i,j) = LocalContrast(i,j) + (I(i,j) - I(i_Test,j_Test));
                end
                
            end
        end
        
    end
end

%--------------------------------------------------------------------------
% VERIFICATION: PLOT LOCAL CONTRAST SURFACE
%--------------------------------------------------------------------------
% LocalContrast_Lim = fSetValueLimits(LocalContrast(:,:),-0.01,5);
% 
% % THRESHOLD = 0.5 (RED = 1)
% figure('Colormap',[0 0 0.5625;0 0.16666667163372 0.635416686534882;0 0.333333343267441 0.708333313465118;0 0.5 0.78125;0 0.666666686534882 0.854166686534882;0 0.833333313465118 0.927083313465118;0 1 1;1 1 0;1 0.857142865657806 0;1 0.714285731315613 0;1 0.571428596973419 0;1 0.428571432828903 0;1 0.28571429848671 0;1 0.142857149243355 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0;1 0 0]);
% % THRESHOLD = 1
% % figure('Colormap',[0 0 0.5625;0 0.0833333358168602 0.598958313465118;0 0.16666667163372 0.635416686534882;0 0.25 0.671875;0 0.333333343267441 0.708333313465118;0 0.416666656732559 0.744791686534882;0 0.5 0.78125;0 0.583333313465118 0.817708313465118;0 0.666666686534882 0.854166686534882;0 0.75 0.890625;0 0.833333313465118 0.927083313465118;0 0.916666686534882 0.963541686534882;0 1 1;1 1 0;1 0.980000019073486 0;1 0.959999978542328 0;1 0.939999997615814 0;1 0.920000016689301 0;1 0.899999976158142 0;1 0.879999995231628 0;1 0.860000014305115 0;1 0.839999973773956 0;1 0.819999992847443 0;1 0.800000011920929 0;1 0.779999971389771 0;1 0.759999990463257 0;1 0.740000009536743 0;1 0.720000028610229 0;1 0.699999988079071 0;1 0.680000007152557 0;1 0.660000026226044 0;1 0.639999985694885 0;1 0.620000004768372 0;1 0.600000023841858 0;1 0.579999983310699 0;1 0.560000002384186 0;1 0.540000021457672 0;1 0.519999980926514 0;1 0.5 0;1 0.479999989271164 0;1 0.46000000834465 0;1 0.439999997615814 0;1 0.419999986886978 0;1 0.400000005960464 0;1 0.379999995231628 0;1 0.360000014305115 0;1 0.340000003576279 0;1 0.319999992847443 0;1 0.300000011920929 0;1 0.280000001192093 0;1 0.259999990463257 0;1 0.239999994635582 0;1 0.219999998807907 0;1 0.200000002980232 0;1 0.180000007152557 0;1 0.159999996423721 0;1 0.140000000596046 0;1 0.119999997317791 0;1 0.100000001490116 0;1 0.0799999982118607 0;1 0.0599999986588955 0;1 0.0399999991059303 0;1 0.0199999995529652 0;1 0 0]);
% % THRESHOLD = 3
% % figure('Colormap',[0 0 0.5625;0 0.0263157896697521 0.57401317358017;0 0.0526315793395042 0.585526287555695;0 0.0789473652839661 0.597039461135864;0 0.105263158679008 0.608552634716034;0 0.131578952074051 0.620065808296204;0 0.157894730567932 0.631578922271729;0 0.184210523962975 0.643092095851898;0 0.210526317358017 0.654605269432068;0 0.236842110753059 0.666118443012238;0 0.263157904148102 0.677631556987762;0 0.289473682641983 0.689144730567932;0 0.315789461135864 0.700657904148102;0 0.342105269432068 0.712171077728271;0 0.368421047925949 0.723684191703796;0 0.394736856222153 0.735197365283966;0 0.421052634716034 0.746710538864136;0 0.447368413209915 0.758223712444305;0 0.473684221506119 0.76973682641983;0 0.5 0.78125;0 0.526315808296204 0.79276317358017;0 0.552631556987762 0.804276287555695;0 0.578947365283966 0.815789461135864;0 0.60526317358017 0.827302634716034;0 0.631578922271729 0.838815808296204;0 0.657894730567932 0.850328922271729;0 0.684210538864136 0.861842095851898;0 0.710526287555695 0.873355269432068;0 0.736842095851898 0.884868443012238;0 0.763157904148102 0.896381556987762;0 0.789473712444305 0.907894730567932;0 0.815789461135864 0.919407904148102;0 0.842105269432068 0.930921077728271;0 0.868421077728271 0.942434191703796;0 0.89473682641983 0.953947365283966;0 0.921052634716034 0.965460538864136;0 0.947368443012238 0.976973712444305;0 0.973684191703796 0.98848682641983;0 1 1;1 1 0;1 0.958333313465118 0;1 0.916666686534882 0;1 0.875 0;1 0.833333313465118 0;1 0.791666686534882 0;1 0.75 0;1 0.708333313465118 0;1 0.666666686534882 0;1 0.625 0;1 0.583333313465118 0;1 0.541666686534882 0;1 0.5 0;1 0.458333343267441 0;1 0.416666656732559 0;1 0.375 0;1 0.333333343267441 0;1 0.291666656732559 0;1 0.25 0;1 0.20833332836628 0;1 0.16666667163372 0;1 0.125 0;1 0.0833333358168602 0;1 0.0416666679084301 0;1 0 0]);
% surface(LocalContrast_Lim,'LineStyle','none')
% axis equal
% 
% clear LocalContrast_Lim
%--------------------------------------------------------------------------
